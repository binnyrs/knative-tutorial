<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup :: Knative Tutorial Docs</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial/0.0.1/1setup.html">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">Knative Tutorial</a>
        <span class="separator">//</span>
        <a href="https://redhat-developer-demos.github.io/knative-tutorial">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial">Knative Tutorial
              Repository</a>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial/issues">Knative
              Tutorial Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/rhdevelopers">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="knative-tutorial" data-version="0.0.1">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Knative Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Knative Tutorial</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="1setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#minishift">Setup MiniShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#admission-controller-webhook">Enable Admission Controller Webhook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#configure-openshift-project">Configuring OpenShift project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install-istio">Install Istio</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#install-knative-serving">Install Knative Serving</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="2get_started.html">2. Get Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#environment">Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#sources">Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="2get_started.html#deploy-services">Build and Deploy Services</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="2.1get_started_nodejs.html">NodeJs</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.1get_started_nodejs.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.1get_started_nodejs.html#create-nodejs-service">Create Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.1get_started_nodejs.html#build-nodejs-service">Build Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.1get_started_nodejs.html#deploy-nodejs-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.1get_started_nodejs.html#invoke-nodejs-service">Invoke Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="2.2get_started_java.html">Java</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.2get_started_java.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.2get_started_java.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.2get_started_java.html#create-java-service">Create Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.2get_started_java.html#build-java-service">Build Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.2get_started_java.html#deploy-java-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="2.2get_started_java.html#invoke-java-service">Invoke Service</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#points-to-ponder">Point to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="3.revisions_configurations.html">3. Revisions and Configurations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3.revisions_configurations.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3.revisions_configurations.html#roll-out-changes">Change Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3.revisions_configurations.html#rollback-changes">Rollback Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3.revisions_configurations.html#invoke-rev-service">Invoke Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="4.eventing.html">Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4.eventing.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4.eventing.html#install-knative-eventing">Install Knative Eventing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="5.traffic_splitting.html">Traffic Splitting</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Knative Tutorial</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Knative Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Knative Tutorial</a></li>
    <li class="crumb"><a href="1setup.html">1. Setup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial/edit/master/documentation/modules/ROOT/pages/1setup.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Setup</h1>
<div class="sect1">
<h2 id="prerequisite"><a class="anchor" href="#prerequisite"></a>Prerequisite CLI tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You will need in this tutorial:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>minishift</code></p>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/minishift/minishift/releases">Mac OS and Fedora</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>docker</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.docker.com/docker-mac">Mac OS</a></p>
</li>
<li>
<p>Fedora: <code>dnf install docker</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>kubectl</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-via-curl">Mac OS</a></p>
</li>
<li>
<p>Fedora: <code>dnf install kubernetes-client</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>oc (eval $(minishift oc-env))</code></p>
</li>
<li>
<p>Apache Maven</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://archive.apache.org/dist/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz">Mac OS</a></p>
</li>
<li>
<p>Fedora: <code>dnf install maven</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><a href="https://github.com/wercker/stern">stern</a></p>
<div class="ulist">
<ul>
<li>
<p>Mac OS: <code>brew install stern</code></p>
</li>
<li>
<p>Fedora: <code>sudo curl --output /usr/local/bin/stern -L <a href="https://github.com/wercker/stern/releases/download/1.6.0/stern_linux_amd64" class="bare">https://github.com/wercker/stern/releases/download/1.6.0/stern_linux_amd64</a> &amp;&amp; sudo chmod +x /usr/local/bin/stern</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>istioctl (will be installed via the steps below)</p>
</li>
<li>
<p><code>curl</code>, <code>gunzip</code>, <code>tar</code></p>
<div class="ulist">
<ul>
<li>
<p>Mac OS: built-in or part of your bash shell</p>
</li>
<li>
<p>Fedora: should also be installed already, but just in case&#8230;&#8203; <code>dnf install curl gzip tar</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>git</p>
<div class="ulist">
<ul>
<li>
<p><code>dnf install git</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="minishift"><a class="anchor" href="#minishift"></a>Setup minishift</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

minishift profile set serverless
minishift config set memory 8GB
minishift config set cpus 4
minishift config set image-caching true
minishift addon enable admin-user
minishift addon enable anyuid

minishift start

eval $(minishift docker-env) &amp;&amp; eval $(minishift oc-env)</code></pre>
</div>
</div>
<div id="admission-controller-webhook" class="paragraph">
<p>Enable Admission Controller Webhook</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

minishift openshift config set --target=kube --patch '{
    "admissionConfig": {
        "pluginConfig": {
            "ValidatingAdmissionWebhook": {
                "configuration": {
                    "apiVersion": "v1",
                    "kind": "DefaultAdmissionConfig",
                    "disable": false
                }
            },
            "MutatingAdmissionWebhook": {
                "configuration": {
                    "apiVersion": "v1",
                    "kind": "DefaultAdmissionConfig",
                    "disable": false
                }
            }
        }
    }
}'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Please allow few minutes for the OpenShift to be restarted with admission hooks enabled.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-openshift-project"><a class="anchor" href="#configure-openshift-project"></a>Configuring OpenShift project</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="login-as-admin"><a class="anchor" href="#login-as-admin"></a>Login as admin user</h3>
<div class="paragraph">
<p>Since there was an <code>admin</code> addon added during minishift configuration, its now possible to login with the <code>admin</code> user. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc login -u admin -p admin</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setup-knative-project"><a class="anchor" href="#setup-knative-project"></a>Setup project to be used for Knative applications</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc project myproject
oc adm policy add-scc-to-user privileged -z myproject <i class="conum" data-value="1"></i><b>(1)</b>
oc label namespace myproject istio-injection=enabled <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>oc adm policy</code> adds the <strong>privileged</strong> <a href="https://docs.okd.io/3.10/admin_guide/manage_scc.html">Security Context Constraints(SCCs)</a>to the <strong>default</strong> Service Account. The SCCs are the precursor to the PSP (Pod Security Policy) mechanism in Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ensures that the project <strong>myproject</strong> is labelled for Istio automatic sidecar injection.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Avoid using <code>default</code> project in OpenShift for deploying Knative applications. As OpenShift deploys few of its mission critical applications in <code>default</code> project, its safe not to touch to avoid any crash to the OpenShift.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-istio"><a class="anchor" href="#install-istio"></a>Install Istio</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="istio-policies"><a class="anchor" href="#istio-policies"></a>Configure Istio Policies</h3>
<div class="paragraph">
<p>Knative depends on Istio, to deploy Istio you need to run the following commands to configure necessary <a href="https://istio.io/docs/setup/kubernetes/platform-setup/openshift/">privileges</a> to the service accounts used by Istio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc adm policy add-scc-to-user anyuid -z istio-ingress-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z default -n istio-system
oc adm policy add-scc-to-user anyuid -z prometheus -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-egressgateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-citadel-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-ingressgateway-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-cleanup-old-ca-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-mixer-post-install-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-mixer-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-pilot-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-sidecar-injector-service-account -n istio-system
oc adm policy add-scc-to-user anyuid -z istio-galley-service-account -n istio-system</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-istio"><a class="anchor" href="#deploy-istio"></a>Deploy Istio Components</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -L https://storage.googleapis.com/knative-releases/serving/latest/istio.yaml \
    | sed 's/LoadBalancer/NodePort/' \
    | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can moinitor the Istio components via the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pods -n istio-system -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It will take a few minutes for all the Istio components to be up and running. Please wait for all the Istio pods to be running before deploying <a href="#install-knative-serving">Knative Serving</a>.  Use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> to exit watch mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="update-istio-sidecar-injector-configmap"><a class="anchor" href="#update-istio-sidecar-injector-configmap"></a>Update Istio sidecar injector ConfigMap</h3>
<div class="paragraph">
<p>The Istio v1.0.1 release automatic sidecar injection has removed <code>privileged:true</code> from init contianers,this will cause the Pods with istio proxies automatic inject to crash. Run the following command to update the <strong>istio-sidecar-injector</strong> ConfigMap.</p>
</div>
<div class="paragraph">
<p>The following command ensures that the <code>privileged:true</code> is added to the <strong>istio-sidecar-injector</strong> ConfigMap:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get cm istio-sidecar-injector -n istio-system -oyaml  \
| sed -e 's/securityContext:/securityContext:\\n      privileged: true/' \
| kubectl replace -f -</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Run the above command only once per minishift instance
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-knative-serving"><a class="anchor" href="#install-knative-serving"></a>Install Knative Serving</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="knative-policies"><a class="anchor" href="#knative-policies"></a>Configure Istio Policies</h3>
<div class="paragraph">
<p>To deploy Knative you need to run the following commands to configure necessary <a href="https://istio.io/docs/setup/kubernetes/platform-setup/openshift/">privileges</a> to the service accounts used by Knative.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc adm policy add-scc-to-user anyuid -z build-controller -n knative-build
oc adm policy add-scc-to-user anyuid -z controller -n knative-serving
oc adm policy add-scc-to-user anyuid -z autoscaler -n knative-serving
oc adm policy add-scc-to-user anyuid -z kube-state-metrics -n knative-monitoring
oc adm policy add-scc-to-user anyuid -z node-exporter -n knative-monitoring
oc adm policy add-scc-to-user anyuid -z prometheus-system -n knative-monitoring
oc adm policy add-cluster-role-to-user cluster-admin -z build-controller -n knative-build
oc adm policy add-cluster-role-to-user cluster-admin -z controller -n knative-serving
oc adm policy add-scc-to-user anyuid -z eventing-controller -n knative-eventing
oc adm policy add-cluster-role-to-user cluster-admin -z eventing-controller -n knative-eventing</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploy-knative-serving"><a class="anchor" href="#deploy-knative-serving"></a>Deploy Knative Serving Components</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -L https://storage.googleapis.com/knative-releases/serving/latest/release-lite.yaml \
    | sed 's/LoadBalancer/NodePort/' \
    | kubectl apply -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can moinitor the Istio components via the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -n knative-serving -w
oc get pods -n knative-build -w</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It will take a few minutes for all the Istio components to be up and running. Use <span class="keyseq"><kbd>CTRL</kbd>+<kbd>C</kbd></span> to exit watch mode.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://developers.redhat.com">Red Hat Developer</a> - Register today!.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
