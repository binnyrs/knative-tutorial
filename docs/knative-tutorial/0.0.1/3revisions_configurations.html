<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisions and Configurations :: Knative Tutorial Docs</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial/0.0.1/3revisions_configurations.html">
    <meta name="generator" content="Antora 1.1.1">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="#">Knative Tutorial</a>
        <span class="separator">//</span>
        <a href="https://redhat-developer-demos.github.io/knative-tutorial">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Project</div>
          <div class="navbar-dropdown">
            <div class="navbar-item"><strong>GitHub</strong></div>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial">Knative Tutorial
              Repository</a>
            <a class="navbar-item" href="https://github.com/redhat-developer-demos/knative-tutorial/issues">Knative
              Tutorial Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/rhdevelopers">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header><div class="main-wrapper">
<div class="navigation-container" data-component="knative-tutorial" data-version="0.0.1">
  <aside class="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Knative Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction to Knative Tutorial</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="1setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#prerequisite">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#minishift">Setup MiniShift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#admission-controller-webhook">Enable Admission Controller Webhook</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#configure-openshift-project">Configuring OpenShift project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#install-istio">Install Istio</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="1setup.html#install-knative-serving">Install Knative Serving</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="2get_started.html">2. Get Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#environment">Environment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#sources">Sources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#build-services">Build Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#deploy-service">Deploy Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="2get_started.html#invoke-service">Invoke Service</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-toggle"></button>
    <a class="nav-link" href="3revisions_configurations.html">Revisions and Configurations</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#roll-out-changes">Change Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#rollback-changes">Rollback Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#invoke-service">Invoke Service</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#points-to-ponder">Point to Ponder</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="4routing_traffic.html">Traffic Splitting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="5build.html">Build</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="6eventing.html">Eventing</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Knative Tutorial</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Knative Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="crumbs" aria-label="breadcrumbs">
  <ul>
    <li class="crumb"><a href="index.html">Knative Tutorial</a></li>
    <li class="crumb"><a href="3revisions_configurations.html">Revisions and Configurations</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/kameshs/git/kameshsampath/knative-tutorial/documentation/modules/ROOT/pages/3revisions_configurations.adoc">Edit this Page</a></div>
</div>
<article class="doc">
<h1>Revisions and Configurations</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Knative follows <a href="https://12factor.net/">12-factor</a> application principles where in every configuration change leads to a new revision.  The configuration change could be image change, environment variables gets added or removed from the configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get configurations.serving.knative.dev <i class="conum" data-value="1"></i><b>(1)</b>
kubectl get revisions.serving.knative.dev <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Will return only one configuration called <code>greeter</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Will return only one revision something like <code>greeter-00001</code></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="roll-out-changes"><a class="anchor" href="#roll-out-changes"></a>Rolling out new changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous service deployments we did update the image from NodeJS to Java, now lets add a new environment variable(s) to the configuration and we will observe that it triggers new revision and deployment :</p>
</div>
<div class="sect2">
<h3 id="_adding_environment_variable"><a class="anchor" href="#_adding_environment_variable"></a>Adding Environment variable</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $PROJECT_HOME/solutions/getstarted</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the <code>service-env.yaml</code> in the folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  runLatest:
    configuration:
      revisionTemplate:
        spec:
          container:
            image: dev.local/greeter:0.0.2
            env:
             - name: MESSAGE_PREFIX <i class="conum" data-value="1"></i><b>(1)</b>
               value: Hello</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Updating the configuration with a environment variable called "MESSAGE_PREFIX"</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Make the greeter application to use the <code>MESSAGE_PREFIX</code>, in the solutions (java or node)  sources uncomment code that is marked as <strong>new revison rollout change</strong> and make sure to update the container image tag to <code>0.0.2</code> while rebuilding.  Refer to ** <a href="2get_started.html#deploy-services" class="page">Build Services</a> for more details.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For Java service update the <code>version</code> to <code>0.0.2</code> in <strong>pom.xml</strong>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_service"><a class="anchor" href="#_deploy_service"></a>Deploy Service</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl apply -f service-env.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The service deployment should now trigger a new revision something like <code>greeter-00002</code> and a new deployment for the revision named <code>greeter-00002-deployment</code> and it will available in the OpenShift dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/greeter-00002.png" alt="Java Greeter Service">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="points-to-ponder"><a class="anchor" href="#points-to-ponder"></a>Points to Ponder</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After you have deployed the new revision of the service, you would have notice that it had triggered a new Kubernetes deployment something like <code>greeter-00002-deployment</code>.  Wondering the reason for it, lets compare the two <code>service.yaml</code> that were deployed:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Greeter Service</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  runLatest:
    configuration:
      revisionTemplate:
        spec:
          container:
            image: dev.local/greeter:0.0.1</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  runLatest:
    configuration:
      revisionTemplate:
        spec:
          container:
            image: dev.local/greeter:0.0.1
            env:
              - name: MESSAGE_PREFIX
                value: Hello</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you observe the only difference between the two service deployments is the <strong>env</strong> variables, which is a configuration change that had caused new revision rollout.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Knative follows <a href="https://12factor.net/">12-factor</a> application principles where in every configuration change leads to a new revision,
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get configurations.serving.knative.dev <i class="conum" data-value="1"></i><b>(1)</b>
kubectl get revisions.serving.knative.dev <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Will return only one configuration called <code>greeter</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Will return two revisions something like <code>greeter-00001</code> and <code>greeter-00002</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can <a href="#invoke-service">Invoke the Service</a> to see the changes from new revision</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rollback-changes"><a class="anchor" href="#rollback-changes"></a>Rolling back changes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To Rollback Changes we can could always delete the application and redeploy the previous version.  As Knative is backed by Istio we could still have the newer deployment in but without routing traffic to it.</p>
</div>
<div class="paragraph">
<p>Knative allows us to do this using a strategy called "Pinned Revisions"</p>
</div>
<div class="sect2">
<h3 id="_pinned_revision"><a class="anchor" href="#_pinned_revision"></a>Pinned Revision</h3>
<div class="paragraph">
<p>Use the <code>service-pinned.yaml</code> in <code>$PROJECT_HOME/solutions/getstarted</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: serving.knative.dev/v1alpha1
kind: Service
metadata:
  name: greeter
spec:
  pinned:
    revisionName: greeter-00001  <i class="conum" data-value="1"></i><b>(1)</b>
  configuration:
    revisionTemplate:
      spec:
        container:
          image: dev.local/greeter:0.0.1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this case we are setting it to existing revision called <code>greeter-00001</code></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can set <code>revisionName</code> to any available revision. You can find all the available revisions using the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get revisions.serving.knative.dev</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_service_2"><a class="anchor" href="#_deploy_service_2"></a>Deploy Service</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kubectl apply -f service-pinned.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Though a new revision <code>greeting-00003</code> has been created with previous deployment, with this <strong>pinned</strong> revision rollout strategy we are pinning the service to use revision <code>greeting-00001</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For pinned revision service deployments the configuration section of the <code>service.yaml</code> is completely ignored. But since its a mandatory element of the service schema we leave it in tact with last revision to avoid creation of new revision with the pinned revision service deployment.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="invoke-service"><a class="anchor" href="#invoke-service"></a>Invoke Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The applications can be invoked only using <code>knative-ingress-gateway</code> which was deployed with Knative serving deployment.</p>
</div>
<div class="paragraph">
<p>The following snippet shows how to invoke the greeter nodejs service that was deployed earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">export IP_ADDRESS=$(minishift ip)

export SERVICE_NODEPORT=$(oc get svc knative-ingressgateway -n istio-system -o 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')

export HOST_URL=$(kubectl get routes.serving.knative.dev greeter  -o jsonpath='{.status.domain}')

curl -H "Host: ${HOST_URL}" ${IP_ADDRESS}:${SERVICE_NODEPORT}</code></pre>
</div>
</div>
</div>
</div>
</article>
  </main>
</div>
<footer class="footer">
  <p>This content is brought to you by <a href="http://developers.redhat.com">Red Hat Developer</a> - Register today!.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
